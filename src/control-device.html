<script type="text/javascript">
    let tempList = [];
    // colour
    const COLOR_RGB = 'color-rgb';
    // Color temperature
    const COLOR_TEMPERATURE = 'color-temperature';
    // brightness
    const BRIGHTNESS = 'brightness';
    //power
    const STARTUP = 'startup';

    (function () {
        //render option
        function renderOptions(list, type) {
            if (!list.length || list.length < 1) return '';
            let dom = type == 'category' ? $('#node-input-category') : $('#node-input-device');
            dom.get(0).options.length = 0;
            var optionStr =
                '<option selected="selected" disabled="disabled" style="display:none" value="">' + (type === 'category' ? '</option><option value="all">ALL</option>' : '');
            for (const item of list) {
                let content = type == 'category' ? item.display_category : item.name || item.manufacturer + item.display_category;
                let value = type == 'category' ? item.display_category : item.serial_number;
                if (type == 'device' || (type == 'category' && optionStr.indexOf(content) == -1)) {
                    optionStr += '<option' + ' value=' + value + '>' + content + '</option>';
                }
            }
            return optionStr;
        }

        //Get deviceList
        function getDeviceList(node) {
            const server = $('#node-input-server').val();
            $.ajax({
                type: 'POST',
                url: 'ewelink-cube-api-v1/get-device-list',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ id: server }),
                success(res) {
                    if (res.error === 0) {
                        if (res.data.device_list instanceof Array && res.data.device_list.length > 0) {
                            tempList = [];
                            let deviceList = res.data.device_list;

                            for (const item of deviceList) {
                                if (item.display_category !== 'sensor') {
                                    //remove seed
                                    let params = {
                                        serial_number: item.serial_number,
                                        display_category: item.display_category,
                                        name: item.name,
                                        manufacturer: item.manufacturer,
                                        state: item.state,
                                        capabilities: item.capabilities,
                                    };
                                    tempList.push(params);
                                }
                            }

                            var categoryOption = renderOptions(tempList, 'category');
                            $('#node-input-category').append(categoryOption);

                            if (node.server) {
                                $('#node-input-category').val(node.category);
                                if (node.device) {
                                    renderDeviceOpt(node);
                                    //render action
                                    renderActionByType();
                                }
                            }
                        }
                    }
                },
                error(error) {
                    console.log('network error', error);
                },
            });
        }
        //render device option
        function renderDeviceOpt(node) {
            var categoryVal = $('#node-input-category').val();
            let deviceList = [];
            for (const item of tempList) {
                if (categoryVal === item.display_category) {
                    deviceList.push(item);
                }
            }
            // let deviceList = tempList.find((item) =>categoryVal === item.display_category);

            if (deviceList.length === 0) deviceList = tempList;
            var deviceOption = renderOptions(deviceList, 'device');
            $('#node-input-device').append(deviceOption);
            $('#node-input-device').val(node.device);
        }

        RED.nodes.registerType('control-device', {
            category: 'eWeLink Cube',
            color: '#4697ff',
            defaults: {
                name: {
                    value: '',
                },
                server: {
                    value: '',
                    required: true,
                    type: 'api-server',
                },
                list: {
                    value: '',
                },
                category: {
                    value: '',
                },
                device: {
                    value: '',
                    required: true,
                },
                action: {
                    value: '',
                },
            },
            inputs: 1,
            outputs: 1,
            icon: 'feed.svg',
            label() {
                return this.name || 'control-device';
            },
            oneditprepare() {
                RED.comms.subscribe('EVENT_NODE_RED_ERROR', (topic, payload) => {
                    RED.notify(payload.msg, { type: 'error' });
                });
                const node = this;
                const serverVal = $('#node-input-server').val();
                if (serverVal && serverVal !== '_ADD_') {
                    getDeviceList(node);
                }
                $('#node-input-category').on('focus', () => {
                    getDeviceList(node);
                });

                $('#node-input-category').on('change', () => {
                    var categoryVal = $('#node-input-category').val();
                    $('.main-area').empty();
                    $('#node-input-device').val('');
                    let deviceList = [];
                    for (const item of tempList) {
                        if (categoryVal == item.display_category) {
                            deviceList.push(item);
                        }
                    }
                    if (deviceList.length === 0) deviceList = tempList;
                    var deviceOption = renderOptions(deviceList, 'device');
                    $('#node-input-device').append(deviceOption);
                    if (node.server) {
                        $('#node-input-device').val(node.device);
                    }
                    renderActionByType();
                });

                $('#node-input-device').on('change', () => {
                    renderActionByType();
                });
            },
            oneditsave: function () {
            },
        });
    })();

    //render option
    function renderOptionByList(List) {
        if (!List || List.length < 1) return;
        let templateStr = '<option selected="selected" value="">未选择</option>'; //disabled="disabled"
        for (const item of List) {
            templateStr += '<option' + ' value=' + item.value + '>' + item.name + '</option>';
        }
        return templateStr;
    }

    //category device
    function renderActionByType() {
        $('.main-area').empty();
        const deviceVal = $('#node-input-device').val();
        let device = {};
        if (deviceVal) {
            device = tempList.find((item) => item.serial_number === deviceVal);
        }
        const res = categoryComponentMapping(device);
        $('.main-area').append(res);
        //Initialize assignment
        initialization(device);
    }

    function initialization(device) {
        const listVal = $('#node-input-list').val();
        if(!listVal)return;
        const params = JSON.parse($('#node-input-list').val());
        const deviceVal = $('#node-input-device').val();
        if (params.deviceId === deviceVal) {
            switch (device.display_category) {
                case 'curtain':
                    $('#curtain').val(params.curtain);
                    break;
                case 'plug':
                case 'switch':
                    const toggle = device.state.toggle;
                    if (!toggle) {
                        $('#single-switch').val(params.single);
                    } else {
                        $('.multi-swtich').each(function (index, item) {
                            $(this).val(params.multi[index + 1]);
                        });
                    }
                    break;
                case 'light':
                    $('#power').val(params.light.power);
                    $('#brightness').val(params.light.brightness);
                    $('#FiveOrTwoLight').val(params.light.type);
                    changeMode();

                    if(params.light.type === COLOR_RGB){
                        $('#light-color').val(params.light.colorOrTemp);
                        setColor();
                    }
                    if(params.light.type === COLOR_TEMPERATURE){
                        $('#light-temp').val(params.light.colorOrTemp);
                    }
                    break;
                default:
                    break;
            }
        }
    }
    //category mapping
    function categoryComponentMapping(device) {
        switch (device.display_category) {
            case 'curtain':
                return `<div class='device'>
                            <span class="device-name">百分比控制</span>
                            <input
                                oninput="if(value>100)value=100;if(value<0)value=0"
                                type="number"
                                placeholder="百分比值 (0%~100%)"
                                style="width:328px"
                                onblur="curtainChange(this)"
                                id="curtain"
                            />
                        </div>`;
            case 'plug':
            case 'switch':
                let params = [];
                let temp = '';
                const toggle = device.state.toggle;
                if (!toggle) {
                    params.push(device.state.power);
                    return (temp += `
                            <div class='device'>
                                <span class="device-name">开关</span>
                                <select id="single-switch" class="switch-select" onchange="changeSwitch(this,'single')">
                                    ${renderOptionByList(operationSwitchSelect.single)}
                                </select>
                            </div>
                        `);
                } else {
                    params = Object.values(toggle); //object
                    params.forEach((item, index) => {
                        temp += `
                            <div class='device'>
                                <span class="device-name">swtich${index + 1}</span>
                                <select class="multi-swtich" onchange="changeSwitch(this,'multi')">
                                    ${renderOptionByList(operationSwitchSelect.multi)}
                                </select>
                            </div>
                        `;
                    });
                    return temp;
                }
            case 'light':
                const capabilities = device.capabilities;
                const color_rgb = capabilities.some((item) => item.capability === COLOR_RGB); //5
                const color_tempature = capabilities.some((item) => item.capability === COLOR_TEMPERATURE); //2
                return `<div class="device">
                            <span class="device-name">开关</span>
                            <select class="switch-select" id="power" onchange="changeLight()">
                                ${renderOptionByList(lightSelect.switch)}
                            </select>
                        </div>

                        <div class="device brightness" style="position:relative">
                            <span class="device-name">亮度</span>
                            <input
                                oninput="if(value>100)value=100;if(value<0)value=0"
                                type="number"
                                class="switch-select"
                                placeholder='亮度百分比(0%-100%)'
                                style="width:328px!important"
                                id="brightness"
                                onchange="changeLight()"
                            />
                            <i class="clear" onClick="$('#brightness').val('');changeLight()">×</i>
                        </div>

                        <div id='colorAndtemp' class="device" style="dispaly:${color_rgb || color_tempature ? 'block' : 'none'};position:relative">
                            <select
                                class="half-action"
                                style="width:64px!important;margin-right:22px"
                                id="FiveOrTwoLight"
                                onchange="changeMode()"
                            >
                                <option value='color-temperature'>色温</option>
                                <option value='color-rgb' style="display:${color_rgb ? 'block' : 'none'}">颜色</option>
                            </select>
                            <input
                                id='light-temp'
                                oninput='if(value>100)value=100;if(value<0)value=0'
                                type='number'
                                class='switch-select'
                                onblur='changeLight()'
                                placeholder='色温百分比 (0%-100%)'
                            />
                            <i class="clear" onClick="$('#light-temp').val('');$('#light-color').val('');changeLight();setColor();">×</i>
                        </div>`;
            default:
                return '';
        }
    }
    //curtain
    function curtainChange(val) {
        $('#node-input-list').val('');
        const curtain = $('#curtain').val();
        const deviceVal = $('#node-input-device').val();
        const params = { type:'curtain',curtain: curtain, deviceId: deviceVal };
        if (curtain) {
            $('#node-input-list').val(JSON.stringify(params));
        }
    }
    //plug、Switch
    function changeSwitch(value, type) {
        $('#node-input-list').val('');
        const deviceVal = $('#node-input-device').val();
        let params = {};
        if (type === 'single') {
            const singleVal = $('#single-switch').val();
            params = { type:'single',single: singleVal, deviceId: deviceVal };
            if (singleVal) {
                $('#node-input-list').val(JSON.stringify(params));
            }
        } else if (type === 'multi') {
            const multiVal = $('.multi-swtich');
            let multi = {};
            $('.multi-swtich').each(function (index, item) {
                if ($(this).val()) {
                    multi[index + 1] = $(this).val();
                    params.multi = multi;
                    params.deviceId = deviceVal;
                    params.type="multi";
                }
            });
            $('#node-input-list').val(JSON.stringify(params));
        }
        console.log('params>>>>>>>>>>>>>>>>>>>>>',params);
    }

    function changeMode() {
        const type = $('#FiveOrTwoLight').val();
        $('#light-color').remove();
        $('#light-temp').remove();
        $('.color-box').remove();

        if (type === COLOR_TEMPERATURE) {
            $('#colorAndtemp').append(
                `<input
                    id="light-temp"
                    oninput="if(value>100)value=100;if(value<0)value=0"
                    type="number"
                    class="switch-select"
                    onblur="changeLight()"
                    placeholder='色温百分比 (0%-100%)'
                />
                `
            );
        } else {
            $('#colorAndtemp').append(
                `<input
                    id="light-color"
                    class="switch-select"
                    onblur="changeLight()"
                    placeholder='16进制RGB值(如#FF0000)'
                    onchange="setColor(this)"
                    style="width:110%!important"
                    onkeyup="value=value.replace(/[^#\dA-Fa-f/g,'')"
                    maxlength="8"
                />
                <i class="color-box"></i>
                `
            );
        }
    }
    //light
    function changeLight() {
        const deviceVal = $('#node-input-device').val();
        let device = tempList.find((item) => item.serial_number === deviceVal);
        const powerVal = $('#power').val();
        const brightness = $('#brightness').val();

        //judge light type by capabilities
        const capabilities = device.capabilities;
        const color_rgb = capabilities.some((item) => item.capability === COLOR_RGB); //5
        const color_tempature = capabilities.some((item) => item.capability === COLOR_TEMPERATURE); //2
        let colorOrTemp = '';
        let hslStr = '';
        const lightType = $('#FiveOrTwoLight').val();
        if (color_tempature && color_rgb) {
            if (lightType === COLOR_TEMPERATURE) {
                colorOrTemp = $('#light-temp').val();
            } else if (lightType === COLOR_RGB) {
                colorOrTemp = $('#light-color').val();
                hslStr = $(".color-box").css("background-color");
            }
        } else if (color_tempature && !color_rgb) {
            colorOrTemp = $('#light-temp').val();
        }
        const params = {
            type:'light',
            deviceId: deviceVal,
            light: {
                power: powerVal,
                brightness,
                type:lightType,
                colorOrTemp,
                hslStr
            },
        };
        if (deviceVal) {
            $('#node-input-list').val(JSON.stringify(params));
        }
        console.log('>>>>>>>>>>>>>>>>>>>', powerVal, brightness, lightType, colorOrTemp);
    }

    function setColor(value){
        const colorVal = $('#light-color').val();
        $('.color-box').css("background-color", colorVal);
    }

    /** switch */
    const operationSwitchSelect = {
        multi: [
            {
                name: 'on',
                value: 'on',
            },
            {
                name: 'off',
                value: 'off',
            },
            {
                name: 'keep',
                value: 'keep',
            },
            {
                name: 'reverse',
                value: 'reverse',
            },
        ],
        single: [
            {
                name: 'on',
                value: 'on',
            },
            {
                name: 'off',
                value: 'off',
            },
            {
                name: 'reverse',
                value: 'reverse',
            },
        ],
    };
    // light
    const lightSelect = {
        switch: [
            {
                name: 'on',
                value: 'on',
            },
            {
                name: 'off',
                value: 'off',
            },
        ],
    };
</script>

<script type="text/html" data-template-name="control-device">
    <div class="form-row">
        <label for="node-input-name"> Name </label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-input-server"> Server </label>
        <input type="text" id="node-input-server" placeholder="Server" />
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-list"> List </label>
        <input type="text" id="node-input-list"/>
    </div>
    <div class="form-row">
        <label for="node-input-category"> Category </label>
        <select id="node-input-category" placeholder="Category" style="width:70%"></select>
    </div>
    <div class="form-row">
        <label for="node-input-device"> Device </label>
        <select id="node-input-device" placeholder="Device" style="width:70%"></select>
    </div>
    <div id="action">
        <header id="header">
            <span>Action</span>
        </header>
        <div class="main-area"></div>
    </div>
</script>
<style>
    #action {
        width: 466px;
        border: 1px solid #ccc;
        border-radius: 8px;
    }
    #header {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding: 0 15px;
        height: 46px;
        border-bottom: 1px solid #ccc;
    }
    #add-btn {
        display: inline-block;
        align-items: center;
        width: 28px;
        height: 28px;
        line-height: 28px;
        border-radius: 50%;
        border: none;
        background-color: #333bff;
        color: white;
    }
    .main-area {
        padding: 10px 0px 0 6px;
    }

    .device {
        display: flex;
        justify-content: flex-start;
        width: 95%;
        margin: 0 40px 10px 10px;
        line-height: 34px;
    }
    .device-name {
        display: inline-block;
        width: 85px;
        text-align: left;
    }
    .switch-select,
    .multi-swtich {
        width: 328px !important;
    }
    .half-action {
        display: inline-block;
        width: 140px !important;
        margin-right: 10px;
    }
    .color-box{
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-left: 5px;
        margin-top: 2px;
    }
    .clear{
        position: absolute;
        display: none;
        top:7px;
        right:50px;
        width: 18px;
        height: 18px;
        line-height: 18px;
        border-radius: 50%;
        background-color: #FFFF;
        text-align: center;
        color: #ccc;
        cursor: pointer;
        border:1px solid #ccc;
    }
    .brightness:hover .clear{
        display: block;
    }
    #colorAndtemp:hover .clear{
        display: block;
    }
</style>
