<script type="text/html" data-template-name="api-server">
    <div class="form-row">
        <label for="node-config-input-name">
            <i class="fa fa-tag"></i>
            Name
        </label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-ip">
            <i class="fa fa-server"></i>
            IP
        </label>
        <div style="display: inline-flex; width: 70%;">
            <input type="text" id="node-config-input-ip" style="width: 100%; margin-right: 10px;">
            <a class="red-ui-button" id="node-config-input-search-btn">
                <i class="fa fa-search"></i>
            </a>
        </div>
    </div>
    <div class="form-row">
        <label>
            <i class="fa fa-id-badge"></i>
            Token
        </label>
        <button id="node-config-input-get-token-btn" type="button" class="red-ui-button" style="width: 70%;" disabled>GET TOKEN</button>
    </div>
</script>

<script type="text/javascript">
;(function () {
    const searchBtnId = '#node-config-input-search-btn';
    const searchBtnIconId = searchBtnId + ' i';
    const getTokenBtnId = '#node-config-input-get-token-btn';

    /**
     * Set searchBtnIcon spin state.
     */
    function setSearchBtnIconSpin(val) {
        if (val) {
            $(searchBtnIconId).addClass('spinner');
        } else {
            $(searchBtnIconId).removeClass('spinner');
        }
    }

    function enableGetTokenBtn() {
        $(getTokenBtnId).prop('disabled', false);
    }

    function disableGetTokenBtn() {
        $(getTokenBtnId).prop('disabled', true);
    }

    function searchBtnOnClickHandler() {
        const ip = $('#node-config-input-ip').val().trim();
        if (!ip) {
            console.log('no ip');
            return;
        } else {
            const ipRegex = /(\b25[0-5]|\b2[0-4][0-9]|\b[01]?[0-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}/;
            if (!ipRegex.test(ip)) {
                console.log('ip invalid');
                return;
            } else {
                setSearchBtnIconSpin(true);

                $.ajax({
                    type: 'POST',
                    url: 'get-bridge-info',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify({ ip }),
                    success(res) {
                        console.log(res);
                        setSearchBtnIconSpin(false);
                        try {
                            if (typeof res !== 'object') {
                                console.log('not object');
                            } else if (res.error !== 0) {
                                console.log('req failed');
                            } else {
                                console.log('success');
                                enableGetTokenBtn();
                            }
                        } catch (err) {
                            console.log('parse error');
                        }
                    },
                    error(err) {
                        console.log(err);
                        setSearchBtnIconSpin(false);
                    }
                });
            }
        }
    }

    function getTokenBtnOnClickHandler() {
        const ip = $('#node-config-input-ip').val().trim();
        $.ajax({
            type: 'POST',
            url: 'get-bridge-token',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify({ ip }),
            success(res) {
                console.log(res);
            },
            error(err) {
                console.log(err);
            }
        })
    }

    RED.nodes.registerType('api-server', {
        category: 'config',
        defaults: {
            name: {
                value: '',
            },
            ip: {
                value: '',
                required: true
            }
        },
        label() {
            return this.name || this.ip;
        },
        oneditprepare() {
            // Set search button click event.
            $(searchBtnId).on('click', searchBtnOnClickHandler);

            // Set get token button click event.
            $(getTokenBtnId).on('click', getTokenBtnOnClickHandler);
        }
    });
})();
</script>
