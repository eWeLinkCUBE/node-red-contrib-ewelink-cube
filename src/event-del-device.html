<script type="text/html" data-template-name="event-del-device">
    <div class="form-row">
        <label for="node-input-name">Name</label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-input-server">Server</label>
        <input type="text" id="node-input-server" placeholder="server" />
    </div>
    <div class="form-row">
        <label for="node-input-device">Device</label>
        <select id="node-input-device" placeholder="Device" style="width:70%"></select>
    </div>
</script>

<script type="text/javascript">
    (function () {
        let tempList = [];
        function renderOptions(list, type) {
            if (!list.length || list.length < 1) return '';
            $('#node-input-device').get(0).options.length = 0;
            var optionStr = '<option selected="selected" disabled="disabled" style="display:none"></option>';
            for (const item of list) {
                optionStr += '<option' + ' value=' + item.serial_number + '>' + (item.name || item.manufacturer + item.display_category) + '</option>';
            }
            return optionStr;
        }

        function getDeviceList(node) {
            const server = $('#node-input-server').val();
            $.ajax({
                type: 'POST',
                url: 'ewelink-cube-api-v1/get-device-list',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ id: server }),
                success(res) {
                    if (res.error === 0) {
                        if (res.data.device_list instanceof Array && res.data.device_list.length > 0) {
                            tempList = [];
                            let deviceList = res.data.device_list;

                            for (const item of deviceList) {
                                let params = {
                                    serial_number: item.serial_number,
                                    display_category: item.display_category,
                                    name: item.name,
                                    manufacturer: item.manufacturer,
                                };
                                tempList.push(params);
                            }

                            var deviceOption = renderOptions(tempList);
                            $('#node-input-device').append(deviceOption);

                            if (node.server) {
                                $('#node-input-device').val(node.device);
                            }
                        }
                    }
                },
                error(error) {
                    console.log('network error', error);
                },
            });
        }
        RED.nodes.registerType('event-del-device', {
            category: 'eWeLink Cube',
            color: '#4697ff',
            defaults: {
                name: {
                    value: '',
                },
                server: {
                    value: '',
                    required: true,
                    type: 'api-server',
                },
                device: {
                    value: '',
                },
            },
            inputs: 0,
            outputs: 1,
            icon: 'function.svg',
            label() {
                return this.name || 'event-del-device';
            },
            oneditprepare() {
                const node = this;
                getDeviceList(node);
                $('#node-input-device').on('focus', () => {
                    getDeviceList(node);
                });
            },
        });
    })();
</script>