<script type="text/javascript">
    (function () {
        let tempList = [];
        function renderOptions(list, type) {
            if (!list.length || list.length < 1) return '';
            let dom = type == 'category' ? $('#node-input-category') : $('#node-input-device');
            dom.get(0).options.length = 0;
            var optionStr = '<option selected="selected" disabled="disabled" style="display:none" value="" label=""></option>';
            for (var i = 0; i <= list.length - 1; i++) {
                let content = type == 'category' ? list[i].display_category : list[i].name;
                let value = type == 'category' ? list[i].display_category : list[i].serial_number;
                if (type == 'device' || (type == 'category' && optionStr.indexOf(content) == -1)) {
                    optionStr += '<option' + ' value=' + value + '>' + content + '</option>';
                }
            }
            return optionStr;
        }

        function getDeviceList() {
            const server = $('#node-input-server').val();
            const tempVal = $('#node-input-category').val();
            tempList = [];
            $.ajax({
                type: 'POST',
                url: 'ewelink-cube-api-v1/get-device-list',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ id: server }),
                success(res) {
                    if (res.data.device_list instanceof Array && res.data.device_list.length > 0) {
                        tempList = [];
                        let deviceList = res.data.device_list;
                        for (var i = 0; i <= deviceList.length - 1; i++) {
                            if (deviceList[i].display_category && deviceList[i].name) {
                                let params = {
                                    serial_number: deviceList[i].serial_number,
                                    display_category: deviceList[i].display_category,
                                    name: deviceList[i].name,
                                };
                                tempList.push(params);
                            }
                        }

                        var categoryOption = renderOptions(tempList, 'category');
                        $('#node-input-category').append(categoryOption);
                        if(tempVal){
                            $('#node-input-category').val(tempVal);
                        }
                    }
                },
                error(error) {
                    console.log('network error', error);
                },
            });
        }
        RED.nodes.registerType('put-device-state', {
            category: 'eWeLink Cube',
            color: '#4697ff',
            defaults: {
                name: {
                    value: '',
                },
                server: {
                    value: '',
                    required: true,
                    type: 'api-server',
                },
                category: {
                    value: '',
                    required: true,
                },
                device: {
                    value: '',
                    required: true,
                    // validate: RED.validators.typedInput('changeValueType')
                },
                state: {
                    value: '',
                    required: true,
                },
            },
            inputs: 1,
            outputs: 1,
            icon: 'bridge.svg',
            label() {
                return this.name || 'put-device-state';
            },
            oneditprepare() {
                $('#node-input-category').on('focus', () => {
                    getDeviceList();
                });

                $('#node-input-category').on('change', () => {
                    var categoryVal = $('#node-input-category').val();
                    $('#node-input-category').val(categoryVal);
                    let deviceList = [];
                    for (var j = 0; j <= tempList.length - 1; j++) {
                        if (categoryVal == tempList[j].display_category) {
                            deviceList.push(tempList[j]);
                        }
                    }
                    var deviceOption = renderOptions(deviceList, 'device');
                    $('#node-input-device').append(deviceOption);
                });

                $('#node-input-device').on('change', () => {
                    var deviceVal = $('#node-input-device').val();
                    // $("#node-input-device").typedInput('value',deviceVal);
                    $('#node-input-device').val(deviceVal);
                });

                $('#add-icon').on('click',()=>{

                });
            },
        });
    })();
</script>

<script type="text/html" data-template-name="put-device-state">
    <div class="form-row">
        <label for="node-input-name"> Name </label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-input-server"> Server </label>
        <input type="text" id="node-input-server" placeholder="server" />
    </div>
    <div class="form-row">
        <label for="node-input-category"> Category </label>
        <select id="node-input-category" name="node-input-category" style="width:70%"></select>
    </div>
    <div class="form-row">
        <label for="node-input-device"> Device </label>
        <select id="node-input-device" name="node-input-device" style="width:70%"></select>
        <!-- multiple="multiple" -->
    </div>
    <div class="form-row">
        <label for="node-input-state"> State </label>
        <div class="right-area">
            <select placeholder="Select State" id="node-input-state" name="node-input-state" style="width:322px"></select>
            <button class="add-icon" id="add-icon">+</button>
            <!-- <span class="del-icon"></span> -->
        </div>
    </div>
</script>

<style>
    .right-area{
        display: inline-block;
    }
    .add-icon ,.del-icon{
        display: inline-block;
        align-items: center;
        width: 28px;
        height: 28px;
        line-height: 28px;
        border-radius: 50%;
    }
</style>
