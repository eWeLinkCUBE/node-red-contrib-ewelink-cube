<script type="text/javascript">
    (function () {
        let tempList = [];
        let List = [];
        function renderOptions(list, type) {
            if (!list.length || list.length < 1) return '';
            let dom = type == 'category' ? $('#node-input-category') : $('#node-input-device');
            dom.get(0).options.length = 0;
            var optionStr = '<option selected="selected" disabled="disabled" style="display:none" value=""></option><option value="all">ALL</option>';
            for (const item of list) {
                let content = type == 'category' ? item.display_category : item.name || item.manufacturer + item.display_category;
                let value = type == 'category' ? item.display_category : item.serial_number;
                if (type == 'device' || (type == 'category' && optionStr.indexOf(content) == -1)) {
                    optionStr += '<option' + ' value=' + value + '>' + content + '</option>';
                }
            }
            return optionStr;
        }

        function getDeviceList(node) {
            const server = $('#node-input-server').val();
            $.ajax({
                type: 'POST',
                url: 'ewelink-cube-api-v1/get-device-list',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ id: server }),
                success(res) {
                    if (res.error === 0) {
                        if (res.data.device_list instanceof Array && res.data.device_list.length > 0) {
                            tempList = [];
                            let deviceList = res.data.device_list;
                            List = res.data.device_list;
                            for (const item of deviceList) {
                                if (item.display_category !== 'sensor') {
                                    //remove seed
                                    let params = {
                                        serial_number: item.serial_number,
                                        display_category: item.display_category,
                                        name: item.name,
                                        manufacturer: item.manufacturer,
                                        state: item.state,
                                    };
                                    tempList.push(params);
                                }
                            }

                            var categoryOption = renderOptions(tempList, 'category');
                            $('#node-input-category').append(categoryOption);

                            if (node.server) {
                                $('#node-input-category').val(node.category);
                                if (node.device) {
                                    renderDeviceOpt(node);
                                    //state
                                    let template = getStateOption().template;
                                    $('#node-input-state').append(template);
                                    node.state && $('#node-input-state').val(node.state);
                                }
                            }
                        }
                    }
                },
                error(error) {
                    console.log('network error', error);
                },
            });
        }

        function renderDeviceOpt(node) {
            var categoryVal = $('#node-input-category').val();
            let deviceList = [];
            for (const item of tempList) {
                if (categoryVal === item.display_category) {
                    deviceList.push(item);
                }
            }
            if (deviceList.length === 0) deviceList = tempList;
            var deviceOption = renderOptions(deviceList, 'device');
            $('#node-input-device').append(deviceOption);
            $('#node-input-device').val(node.device);
        }

        function addItem() {
            let template = getStateOption().template;
            $('#state').append(
                `<div id="main-area">
                            <label for="node-input-state" style="visibility: hidden;"> State </label>
                            <div class="right-area" style="margin-top:10px">
                                <select class="node-input-state-class" name="node-input-state" style="width:322px">
                                    ${template}
                                </select>
                                <button class="del-icon" id="del-icon" onclick="delItem(this)" style="background-color: red">-</button>
                            </div>
                        </div>
                        `
            );
            console.log(document.getElementById('state'));
        }

        function getStateOption() {
            let list = [];
            for (const ele of tempList) {
                if (ele.serial_number === $('#node-input-device').val()) {
                    list.push(ele.state);
                }
            }
            let template = '<option selected="selected" disabled="disabled" style="display:none" value="" label=""></option>';
            let stateLength = 0;
            if (list.length > 0) {
                const stateList = Object.keys(list[0]);
                stateLength = stateList.length;
                for (const item of stateList) {
                    template += `<option value="${item}">${item}</option>`;
                }
            }
            return { template, stateLength };
        }

        RED.nodes.registerType('event-state', {
            category: 'eWeLink Cube',
            color: '#4697ff',
            defaults: {
                name: {
                    value: '',
                },
                server: {
                    value: '',
                    required: true,
                    type: 'api-server',
                },
                category: {
                    value: '',
                },
                device: {
                    value: '',
                },
                state: {
                    value: '',
                },
            },
            inputs: 0,
            outputs: 1,
            icon: 'envelope.svg',
            label() {
                return this.name || 'event-state';
            },
            oneditprepare() {
                const node = this;
                if ($('#node-input-server').val() && $('#node-input-server').val() !== '_ADD_') {
                    getDeviceList(node);
                }

                $('#node-input-category').on('focus', () => {
                    getDeviceList(node);
                });

                $('#node-input-category').on('change', () => {
                    //delete state
                    $('#state #main-area').eq(0).nextAll().remove();

                    $('#node-input-device').val('');
                    $('#node-input-state').get(0).options.length = 0;

                    renderDeviceOpt(node);
                });

                $('#node-input-device').on('change', () => {
                    //delete state
                    $('#state #main-area').eq(0).nextAll().remove();

                    $('#node-input-state').get(0).options.length = 0;
                    let template = getStateOption().template;
                    $('#node-input-state').append(template);
                });

                $('#add-icon').on('click', addItem);
            },
        });
    })();

    function delItem(delbtn) {
        $(delbtn).parents('#main-area').remove();
    }
</script>

<script type="text/html" data-template-name="event-state">
    <div class="form-row">
        <label for="node-input-name"> Name </label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-input-server"> Server </label>
        <input type="text" id="node-input-server" placeholder="server" />
    </div>
    <div class="form-row">
        <label for="node-input-category"> Category </label>
        <select id="node-input-category" placeholder="Category" style="width:70%"></select>
    </div>
    <div class="form-row">
        <label for="node-input-device"> Device </label>
        <select id="node-input-device" placeholder="Device" style="width:70%"></select>
    </div>
    <div class="form-row" id="state">
        <div id="main-area">
            <label for="node-input-state"> State </label>
            <div class="right-area">
                <select placeholder="Select State" id="node-input-state" name="node-input-state" style="width:322px"></select>
                <button class="add-icon" id="add-icon" style="background-color: blue">+</button>
            </div>
        </div>
    </div>
</script>

<style>
    .right-area {
        display: inline-block;
    }
    .add-icon,
    .del-icon,
    #del-icon {
        display: inline-block;
        align-items: center;
        width: 28px;
        height: 28px;
        line-height: 28px;
        border-radius: 50%;
    }
</style>
