<script type="text/html" data-template-name="register-device">
    <div class="form-row">
        <label for="node-input-name">Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-server">Server</label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <label for="node-input-device_id">Device ID</label>
        <input type="text" id="node-input-device_id">
    </div>
    <div class="form-row">
        <label for="node-input-device_name">Device Name</label>
        <input type="text" id="node-input-device_name">
    </div>
    <div class="form-row">
        <label for="node-input-category">Category</label>
        <select name="node-input-category" id="node-input-category" style="width: 70%;"></select>
    </div>
    <div class="form-row" style="display: flex;">
        <label for="node-input-capabilities" style="padding: 6px 3px 0 0;">Capabilities</label>
        <input type="text" id="node-input-capabilities" style="width: 0; height: 0; display: none;">
        <div id="capa-list" style="display: inline-block; width: 70%;"></div>
    </div>
    <div class="form-row">
        <label for="node-input-manufacturer">Manufacturer</label>
        <input type="text" id="node-input-manufacturer">
    </div>
    <div class="form-row">
        <label for="node-input-model">Model</label>
        <input type="text" id="node-input-model">
    </div>
    <div class="form-row">
        <label for="node-input-firmware_version">FW version</label>
        <input type="text" id="node-input-firmware_version">
    </div>
    <div class="form-row">
        <label for="node-input-service_address">Service IP</label>
        <input type="text" id="node-input-service_address">
    </div>
    <div class="form-row">
        <label for="node-input-tags">Tags</label>
        <input type="text" id="node-input-tags" style="width: 70%;">
    </div>
    <div class="form-row">
        <label for="node-input-state">State</label>
        <input type="text" id="node-input-state" style="width: 70%;">
    </div>
</script>

<script type="text/javascript">
;(function () {
    const DOM_ID_INPUT_CATEGORY = '#node-input-category';
    const DOM_ID_INPUT_CAPABILITIES = '#node-input-capabilities';
    const DOM_ID_INPUT_TAGS = '#node-input-tags';
    const DOM_ID_INPUT_STATE = '#node-input-state';
    const DOM_ID_CAPA_LIST = '#capa-list';

    // Device category list
    const CATE_LIST = [
        {
            id: 0,
            name: 'Plug',
            value: 'plug'
        },
        {
            id: 1,
            name: 'Switch',
            value: 'switch'
        },
        {
            id: 2,
            name: 'Light',
            value: 'light'
        },
        {
            id: 3,
            name: 'Curtain',
            value: 'curtain'
        },
        {
            id: 4,
            name: 'ContactSensor',
            value: 'contactSensor'
        },
        {
            id: 5,
            name: 'MotionSensor',
            value: 'motionSensor'
        },
        {
            id: 6,
            name: 'TemperatureSensor',
            value: 'temperatureSensor'
        },
        {
            id: 7,
            name: 'HumiditySensor',
            value: 'humiditySensor'
        },
        {
            id: 8,
            name: 'TemperatureAndHumiditySensor',
            value: 'temperatureAndHumiditySensor'
        },
        {
            id: 9,
            name: 'WaterLeakDetector',
            value: 'waterLeakDetector',
        },
        {
            id: 10,
            name: 'SmokeDetector',
            value: 'smokeDetector',
        },
        {
            id: 11,
            name: 'Button',
            value: 'button'
        }
    ];

    // Device capability list
    const CAPA_LIST = [
        {
            id: 0,
            name: 'Power',
            value: 'power'
        },
        {
            id: 1,
            name: 'Toggle',
            value: 'toggle'
        },
        {
            id: 2,
            name: 'Brightness',
            value: 'brightness'
        },
        {
            id: 3,
            name: 'Color Temperature',
            value: 'color-temperature'
        },
        {
            id: 4,
            name: 'Color RGB',
            value: 'color-rgb'
        },
        {
            id: 5,
            name: 'Percentage',
            value: 'percentage'
        },
        {
            id: 6,
            name: 'Motor Control',
            value: 'motor-control'
        },
        {
            id: 7,
            name: 'Motor Reverse',
            value: 'motor-reverse'
        },
        /* Unsupported
        {
            id: 8,
            name: 'Startup',
            value: 'startup'
        },
        */
        {
            id: 9,
            name: 'Motor CLB',
            value: 'motor-clb'
        },
        {
            id: 10,
            name: 'Detect',
            value: 'detect'
        },
        {
            id: 11,
            name: 'Battery',
            value: 'battery'
        },
        {
            id: 12,
            name: 'Press',
            value: 'press'
        },
        {
            id: 13,
            name: 'RSSI',
            value: 'rssi'
        },
    ];

    RED.nodes.registerType('register-device', {
        category: 'eWeLink Cube',
        color: '#4697ff',
        defaults: {
            name: {
                value: '',
            },
            server: {
                value: '',
                required: true,
                type: 'api-server',
            },
            device_id: {
                value: '',
                required: true
            },
            device_name: {
                value: '',
                required: true
            },
            category: {
                value: '',
                required: true
            },
            capabilities: {
                value: '',
                required: true
            },
            manufacturer: {
                value: '',
                required: true
            },
            model: {
                value: '',
                required: true
            },
            firmware_version: {
                value: '',
                required: true
            },
            service_address: {
                value: '',
                required: true
            },
            tags: {
                value: '',
                required: true
            },
            state: {
                value: '',
                required: true
            }
        },
        inputs: 1,
        outputs: 1,
        icon: 'serial.svg',
        label() {
            return this.name || 'register-device';
        },
        paletteLabel: 'register device',
        oneditprepare() {
            const TOGGLE_SELECT_HTML_STR = '<br><span>Toggle No.</span><select id="capa-toggle-select" style="margin-top: 8px;"><option value="2">2</option><option value="3">3</option><option value="4">4</option></select>';
            $(DOM_ID_INPUT_TAGS).typedInput({
                type: 'json',
                types: ['json']
            });

            $(DOM_ID_INPUT_STATE).typedInput({
                type: 'json',
                types: ['json']
            });

            // Render category list.
            for (const item of CATE_LIST) {
                $(DOM_ID_INPUT_CATEGORY).append(`<option value="${item.value}">${item.name}</option>`);
            }

            // Render capability list.
            const capaJsonData = $(DOM_ID_INPUT_CAPABILITIES).val();
            if (capaJsonData === '') {
                let htmlStr = '';
                for (const item of CAPA_LIST) {
                    htmlStr += `<option value="${item.value}">${item.name}</option>`;
                }
                htmlStr = '<select class="capa-select">' + htmlStr + '</select>';
                htmlStr += '<span class="add-item-btn">+</span>';
                htmlStr = '<div class="capa-list-item">' + htmlStr + '</div>';
                $(DOM_ID_CAPA_LIST).append(htmlStr);
            } else {
                const capaData = JSON.parse(capaJsonData);
                let htmlStr = '';
                for (let i = 0; i < capaData.values.length; i++) {
                    htmlStr += '<div class="capa-list-item" style="margin-top: 8px;">';
                    const found = CAPA_LIST.find((item) => item.value === capaData.values[i]);
                    htmlStr += `<select class="capa-select"><option value="${found.value}">${found.name}</option></select>`;

                    if (i === 0) {
                        htmlStr += '<span class="add-item-btn">+</span>';
                    } else {
                        htmlStr += '<span class="del-item-btn">-</span>';
                    }

                    if (capaData.values[i] === 'toggle') {
                        htmlStr += TOGGLE_SELECT_HTML_STR;
                    }
                    htmlStr += '</div>';
                }
                $(DOM_ID_CAPA_LIST).append(htmlStr);
                $('#capa-toggle-select').val(JSON.parse(capaJsonData).toggleNum);
            }

            // Handle add button and del button onclick event.
            $(DOM_ID_CAPA_LIST).on('click', (event) => {
                const className = event.target.className;
                if (className === 'add-item-btn') {         // Add a new item.
                    const selectList = $(`${DOM_ID_CAPA_LIST} select`);
                    const valList = [];
                    for (let i = 0; i < selectList.length; i++) {
                        valList.push(selectList[i].value);
                    }

                    // Render HTML
                    let htmlStr = '';
                    for (const item of CAPA_LIST) {
                        if (!valList.includes(item.value)) {
                            htmlStr += `<option value="${item.value}">${item.name}</option>`;
                        }
                    }
                    if (htmlStr === '') {
                        return;
                    }
                    htmlStr = '<select class="capa-select">' + htmlStr + '</select>';
                    htmlStr += '<span class="del-item-btn">-</span>';

                    // Get toggle number.
                    let iToggle = htmlStr.indexOf('<option value="toggle">');
                    if (iToggle !== -1) {
                        htmlStr += TOGGLE_SELECT_HTML_STR;
                    }

                    htmlStr = '<div class="capa-list-item" style="margin-top: 8px;">' + htmlStr + '</div>';
                    $(DOM_ID_CAPA_LIST).append(htmlStr);
                } else if (className === 'del-item-btn') {  // Remove a item.
                    $(event.target).parent().remove();
                }
            });

            // Handle select onchange event.
            $(DOM_ID_CAPA_LIST).on('change', (event) => {
                const className = event.target.className;
                if (className === 'capa-select') {
                    const value = event.target.value;
                    let htmlStr = '';
                    if (value === 'toggle') {
                        // Current value is toggle, add toggle elements.
                        htmlStr = TOGGLE_SELECT_HTML_STR;
                        $($(event.target).parent()).append(htmlStr);
                    } else {
                        const children = $($(event.target).parent()).children();
                        const childNum = children.length;
                        if (childNum > 2) {
                            // Previous value is "toggle", remove toggle elements.
                            for (let i = 2; i < childNum; i++) {
                                children[i].remove();
                            }
                        }
                    }
                }
            });

            // Handle select onfocusin event.
            $(DOM_ID_CAPA_LIST).on('focusin', (event) => {
                const className = event.target.className;
                if (className === 'capa-select') {
                    const selectList = $(`${DOM_ID_CAPA_LIST} select`);
                    // Do not replace the first select.
                    if (selectList.length === 1) {
                        return;
                    }
                    const currentVal = event.target.value;
                    const valList = [];
                    for (let i = 0; i < selectList.length; i++) {
                        if (selectList[i].value !== currentVal) {
                            valList.push(selectList[i].value);
                        }
                    }

                    // Render HTML
                    let htmlStr = '';
                    for (const item of CAPA_LIST) {
                        if (!valList.includes(item.value)) {
                            htmlStr += `<option value="${item.value}">${item.name}</option>`;
                        }
                    }
                    if (htmlStr === '') {
                        return;
                    }

                    $(event.target).children().remove();
                    $(event.target).append(htmlStr);

                    // Browser auto select "toggle" option.
                    if (htmlStr.indexOf('<option value="toggle">') === 0 && $('select#capa-toggle-select').length === 0) {
                        $($(event.target).parent()).append(TOGGLE_SELECT_HTML_STR);
                    }
                }
            });
        },
        oneditsave() {
            // Save capabilities data.
            const capaList = $(`${DOM_ID_CAPA_LIST} select`);
            const capaData = {
                toggleNum: '1',
                values: []
            };
            for (let i = 0; i < capaList.length; i++) {
                if (capaList[i].id === 'capa-toggle-select') {
                    capaData.toggleNum = capaList[i].value;
                } else {
                    capaData.values.push(capaList[i].value);
                }
            }
            $(DOM_ID_INPUT_CAPABILITIES).val(JSON.stringify(capaData));
        }
    });
})();
</script>
